<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <title>IPTV Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, orientation=landscape" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.css" />
  <script src="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.polyfilled.min.js"></script>
  <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
  <style>
    html, body {
      margin: 0; padding: 0;
      height: 100%;
      background: black;
      overflow: hidden;
      font-family: Arial, sans-serif;
      color: white;
    }
    #player-container { position: relative; width: 100%; height: 100%; }
    video.plyr { width: 100% !important; height: 100% !important; }
    #channelName, #clock {
      position: absolute;
      background: rgba(0,0,0,0.5);
      padding: 5px 10px;
      border-radius: 5px;
      z-index: 10;
      font-size: 18px;
      transition: opacity 0.5s;
    }
    #channelName { top: 10px; left: 10px; }
    #clock { top: 10px; right: 10px; }
    #categoryList, #channelList {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.95);
      overflow-y: auto;
      display: none;
      z-index: 100;
    }
    .list-item {
      padding: 15px;
      font-size: 22px;
      border-bottom: 1px solid #444;
      cursor: pointer;
    }
    .list-item.active { background-color: #666; }
    #controls {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 20px;
      z-index: 10;
      transition: opacity 0.5s;
    }
    .control-btn {
      background: rgba(0,0,0,0.5);
      border: none;
      color: white;
      font-size: 20px;
      padding: 12px 16px;
      border-radius: 8px;
      cursor: pointer;
    }
    .hidden {
      opacity: 0;
      pointer-events: none;
    }
    #exitConfirm {
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translateX(-50%);
      background: #222;
      padding: 20px 30px;
      border-radius: 10px;
      z-index: 200;
      font-size: 20px;
      display: none;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="player-container">
    <video id="videoPlayer" class="plyr" controls playsinline></video>
    <div id="channelName">Yüklənir...</div>
    <div id="clock"></div>
    <div id="categoryList"></div>
    <div id="channelList"></div>
    <div id="controls">
      <button id="playPauseBtn" class="control-btn">⏯️</button>
      <button id="fullscreenBtn" class="control-btn">⛶</button>
    </div>
    <div id="exitConfirm">Çıxmaq istədiyinizə əminsiniz?</div>
  </div>

  <script>
    const player = new Plyr('#videoPlayer');
    const video = document.getElementById('videoPlayer');
    const clockEl = document.getElementById('clock');
    const channelNameEl = document.getElementById('channelName');
    const categoryListEl = document.getElementById('categoryList');
    const channelListEl = document.getElementById('channelList');
    const controlsEl = document.getElementById('controls');
    const exitConfirmEl = document.getElementById('exitConfirm');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');

    let allChannels = [], categories = {}, currentCategory = '', currentIndex = 0, selectedIndex = 0;
    let categoryVisible = false, channelVisible = false, hideTimer;
    let exitCount = 0, confirmExit = false;

    function updateClock() {
      const now = new Date();
      const time = now.toLocaleTimeString('az-AZ', { hour12: false });
      const date = now.toLocaleDateString('az-AZ');
      clockEl.innerText = `${time} | ${date}`;
    }
    setInterval(updateClock, 1000);
    updateClock();

    const m3uUrl = "https://m3u.ch/1Vdlwj.m3u";

    fetch(m3uUrl)
      .then(res => res.text())
      .then(text => {
        const lines = text.split('\n');
        let temp = {};
        lines.forEach(line => {
          if (line.startsWith('#EXTINF')) {
            const name = line.split(',').pop().trim();
            const groupMatch = line.match(/group-title="([^"]+)"/);
            const category = groupMatch ? groupMatch[1] : 'Digər';
            temp = { name, category };
          } else if (line.startsWith('http')) {
            temp.url = line.trim();
            allChannels.push(temp);
            if (!categories[temp.category]) categories[temp.category] = [];
            categories[temp.category].push(temp);
          }
        });
        renderCategories();
      });

    function renderCategories() {
      categoryListEl.innerHTML = '';
      Object.keys(categories).forEach((cat, index) => {
        const count = categories[cat].length;
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerText = `${cat} (${count})`;
        div.dataset.index = index;
        div.addEventListener('click', () => {
          currentCategory = cat;
          renderChannels(cat);
          toggleCategory(false);
          toggleChannel(true);
        });
        categoryListEl.appendChild(div);
      });
    }

    function renderChannels(cat) {
      const list = categories[cat] || [];
      channelListEl.innerHTML = '';
      list.forEach((ch, i) => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerText = ch.name;
        div.dataset.index = i;
        div.addEventListener('click', () => {
          playChannel(i);
          toggleChannel(false);
        });
        div.addEventListener('touchstart', () => {
          longPressTimeout = setTimeout(() => {
            toggleChannel(false);
            toggleCategory(true);
          }, longPressDuration);
        });
        div.addEventListener('touchend', () => clearTimeout(longPressTimeout));
        channelListEl.appendChild(div);
      });
      highlight(currentIndex);
    }

    function getMimeType(url) {
      const ext = url.split('.').pop().split(/\#|\?/)[0].toLowerCase();
      const types = {
        mp4:'video/mp4', m3u8:'application/x-mpegURL', mpd:'application/dash+xml',
        ts:'video/MP2T', flv:'video/x-flv', webm:'video/webm'
      };
      return types[ext] || 'application/octet-stream';
    }

    function playChannel(index) {
      const list = categories[currentCategory] || [];
      const ch = list[index];
      if (!ch || !ch.url) return;
      const mimeType = getMimeType(ch.url);

      if (mimeType === 'application/dash+xml') {
        if (window.player && window.player.destroy) window.player.destroy();
        video.innerHTML = '';
        const dashPlayer = dashjs.MediaPlayer().create();
        dashPlayer.initialize(video, ch.url, true);
        window.player = new Plyr(video);
      } else {
        video.src = ch.url;
        video.type = mimeType;
        video.load();
        video.play();
      }

      channelNameEl.innerText = `${ch.name} (${index + 1}/${list.length})`;
      currentIndex = index;
      selectedIndex = index;
      highlight(index);
      showUI();
    }

    function toggleCategory(show) {
      categoryVisible = show;
      exitCount = 0;
      confirmExit = false;
      exitConfirmEl.style.display = 'none';
      categoryListEl.style.display = show ? 'block' : 'none';
    }

    function toggleChannel(show) {
      channelVisible = show;
      exitCount = 0;
      confirmExit = false;
      exitConfirmEl.style.display = 'none';
      channelListEl.style.display = show ? 'block' : 'none';
      if (show) highlight(currentIndex);
    }

    function highlight(index) {
      document.querySelectorAll('#channelList .list-item').forEach((el, i) => {
        el.classList.toggle('active', i === index);
      });
      const selected = document.querySelector(`#channelList .list-item[data-index="${index}"]`);
      if (selected) selected.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    document.addEventListener('keydown', e => {
      const key = e.key;
      showUI();

      if (confirmExit) {
        if (key === 'Enter') window.close();
        else if (key === 'Backspace' || key === 'Escape') {
          exitConfirmEl.style.display = 'none';
          confirmExit = false;
        }
        return;
      }

      if (!categoryVisible && !channelVisible && key === 'ArrowLeft') {
        toggleCategory(true); return;
      }

      if (!categoryVisible && !channelVisible && key === 'Enter') {
        toggleChannel(true); return;
      }

      if (categoryVisible) {
        const cats = categoryListEl.querySelectorAll('.list-item');
        if (key === 'ArrowDown') selectedIndex = Math.min(cats.length - 1, selectedIndex + 1);
        else if (key === 'ArrowUp') selectedIndex = Math.max(0, selectedIndex - 1);
        else if (key === 'Enter') {
          currentCategory = cats[selectedIndex].innerText.split(' (')[0];
          renderChannels(currentCategory);
          toggleCategory(false);
          toggleChannel(true);
        } else if (key === 'Backspace' || key === 'Escape') {
          exitCount++;
          if (exitCount >= 2) {
            exitConfirmEl.style.display = 'block';
            confirmExit = true;
          } else toggleCategory(false);
        }
        cats.forEach((el, i) => el.classList.toggle('active', i === selectedIndex));
        return;
      }

      if (channelVisible) {
        const list = categories[currentCategory] || [];
        if (key === 'ArrowDown') selectedIndex = Math.min(list.length - 1, selectedIndex + 1);
        else if (key === 'ArrowUp') selectedIndex = Math.max(0, selectedIndex - 1);
        else if (key === 'Enter') {
          playChannel(selectedIndex);
          toggleChannel(false);
        } else if (key === 'Backspace' || key === 'Escape') {
          toggleChannel(false);
          toggleCategory(true);
        }
        highlight(selectedIndex);
        return;
      }

      if (key === 'ArrowDown') {
        const list = categories[currentCategory] || [];
        playChannel(Math.min(list.length - 1, currentIndex + 1));
      } else if (key === 'ArrowUp') {
        const list = categories[currentCategory] || [];
        playChannel(Math.max(0, currentIndex - 1));
      }
    });

    let touchStartY = 0, touchEndY = 0;
    let longPressTimer = null;
    const longPressDuration = 600;
    let longPressTimeout = null;

    document.addEventListener('touchstart', e => {
      showUI();
      touchStartY = e.changedTouches[0].screenY;
      longPressTimer = setTimeout(() => {
        if (channelVisible) {
          toggleChannel(false);
          toggleCategory(true);
        } else {
          toggleChannel(true);
        }
      }, longPressDuration);
    });

    document.addEventListener('touchend', e => {
      touchEndY = e.changedTouches[0].screenY;
      if (longPressTimer) clearTimeout(longPressTimer);
      handleSwipe();
    });

    document.addEventListener('touchmove', () => {
      if (longPressTimer) clearTimeout(longPressTimer);
    });

    function handleSwipe() {
      const deltaY = touchStartY - touchEndY;
      if (Math.abs(deltaY) < 30 || categoryVisible || channelVisible) return;
      const list = categories[currentCategory] || [];
      if (deltaY > 0 && currentIndex < list.length - 1) playChannel(currentIndex + 1);
      else if (deltaY < 0 && currentIndex > 0) playChannel(currentIndex - 1);
    }

    function showUI() {
      clearTimeout(hideTimer);
      controlsEl.classList.remove('hidden');
      channelNameEl.classList.remove('hidden');
      clockEl.classList.remove('hidden');
      hideTimer = setTimeout(() => {
        controlsEl.classList.add('hidden');
        channelNameEl.classList.add('hidden');
        clockEl.classList.add('hidden');
      }, 5000);
    }

    playPauseBtn.addEventListener('click', () => {
      if (video.paused) video.play();
      else video.pause();
      showUI();
    });

    fullscreenBtn.addEventListener('click', () => {
      const el = document.getElementById('player-container');
      if (!document.fullscreenElement) {
        el.requestFullscreen().then(() => {
          if (screen.orientation && screen.orientation.lock) {
            screen.orientation.lock('landscape').catch(() => {});
          }
        });
      } else {
        document.exitFullscreen();
        if (screen.orientation && screen.orientation.unlock) {
          screen.orientation.unlock();
        }
      }
      showUI();
    });

    showUI();
  </script>
</body>

</html>
